nx=200;
ny=200;
n=nx*ny;
img=100*ones(nx,ny);
img(75:150,75:150)=150*ones(76);
nimg=img+12*randn(nx,ny);
nimg=reshape(nimg,n,1);
lambda=5;
x=zeros(n,1);
k=1;
a1=zeros(n,1);
a2=zeros(n,1);
a3=zeros(n,1);
b1=zeros(n,1);
b2=zeros(n,1);
b3=zeros(n,1);
c1=zeros(n,1);
c2=zeros(n,1);
c3=zeros(n,1);
a1(1)=2*lambda+1;
a1(2)=-lambda;
a1(nx+1)=-lambda;
a2(1)=-lambda;
a2(2)=3*lambda+1;
a2(3)=-lambda;
a2(nx+2)=-lambda;
a3(1)=-lambda;
a3(2)=2*lambda+1;
a3(nx+2)=-lambda;
b1(1)=-lambda;
b1(nx+1)=3*lambda+1;
b1(nx+2)=-lambda;
b1(2*nx+1)=-lambda;
b2(1)=-lambda;
b2(nx)=-lambda;
b2(nx+1)=4*lambda+1;
b2(nx+2)=-lambda;
b2(2*nx+1)=-lambda;
b3(1)=-lambda;
b3(nx)=-lambda;
b3(nx+1)=3*lambda+1;
b3(2*nx+1)=-lambda;
c1(1)=-lambda;
c1(nx+1)=2*lambda+1;
c1(nx+2)=-lambda;
c2(1)=-lambda;
c2(nx)=-lambda;
c2(nx+1)=3*lambda+1;
c2(nx+2)=-lambda;
c3(1)=-lambda;
c3(nx)=-lambda;
c3(nx+1)=2*lambda+1;

while(k<20)
    x1=x;
    x(1)=-1/a1(1)*[0,x1(2:n)']*a1+nimg(1)/a1(1);
    for i=2:nx-1
        a=alt(a2,i-2);
        x(i)=-1/a(i)*[x(1:i-1)',0,x1(i+1:n)']*a+nimg(i)/a(i);
    end
    a=alt(a3,nx-2);
    x(nx)=-1/a(nx)*[x(1:nx-1)',0,x1(nx+1:n)']*a+nimg(nx)/a(nx);
    for i=nx+1:nx*(ny-1)
        if mod(i,nx)==1
            b=alt(b1,i-nx-1);
            x(i)=-1/b(i)*[x(1:i-1)',0,x1(i+1:n)']*b+nimg(i)/b(i);
        elseif mod(i,nx)==0
            b=alt(b2,i-nx-1);
            x(i)=-1/b(i)*[x(1:i-1)',0,x1(i+1:n)']*b+nimg(i)/b(i);
        else
            b=alt(b3,i-nx-1);
            x(i)=-1/b(i)*[x(1:i-1)',0,x1(i+1:n)']*b+nimg(i)/b(i);
        end
    end
    c=alt(c1,nx*(ny-2));
    x(nx*(ny-1)+1)=-1/c(nx*(ny-1)+1)*[x(1:nx*(ny-1)+1-1)',0,x1(nx*(ny-1)+1+1:n)']*c+nimg(nx*(ny-1)+1)/c(nx*(ny-1)+1);
    for i=nx*(ny-1)+1:nx*ny-1
        c=alt(c2,i-nx-1);
        x(i)=-1/c(i)*[x(1:i-1)',0,x1(i+1:n)']*c+nimg(i)/c(i);
    end
    c=alt(c3,nx*(ny-1)-1);
    x(nx*ny)=-1/c(nx*ny)*[x(1:nx*ny-1)',0,x1(nx*ny+1:n)']*c+nimg(nx*ny)/c(nx*ny);
k=k+1;
end
img=uint8(img);
nimg=uint8(nimg);
nimg=reshape(nimg,nx,ny);
imwrite(img,'img.jpg');
imwrite(nimg,'nimg.jpg');
img_denoise=reshape(x,nx,ny);
img_denoise=uint8(img_denoise);
imwrite(img_denoise,'img_denoise.jpg');
subplot(1,3,1)
imshow(img)
title('原图');
subplot(1,3,2)
imshow(nimg)
title('加Gauss噪音');
subplot(1,3,3)
imshow(img_denoise)
title('梯度L^2 norm去噪, \lambda=5');